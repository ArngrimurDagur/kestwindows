# Set CSV path
$csvPath = "C:\Users.csv"

# Default password (change if needed)
$defaultPassword = ConvertTo-SecureString "V3rk3fni!" -AsPlainText -Force

# Import the CSV
$users = Import-Csv $csvPath -Delimiter ','

# Create OUs if they donâ€™t exist
$departments = $users | Select-Object -ExpandProperty Deild -Unique
foreach ($dept in $departments) {
    $ouPath = "OU=$dept,DC=eep-arngrimur,DC=local"
    if (-not (Get-ADOrganizationalUnit -Filter "Name -eq '$dept'" -ErrorAction SilentlyContinue)) {
        New-ADOrganizationalUnit -Name $dept -Path "DC=eep-arngrimur,DC=local"
    }
}

# Create users
foreach ($user in $users) {
    $ou = "OU=$($user.Deild),DC=eep-arngrimur,DC=local"
    $sam = $user.Notendanafn
    $name = $user.Nafn
    $first = $user.Fornafn
    $last = $user.Eftirnafn

    # Skip if user already exists
    if (-not (Get-ADUser -Filter "SamAccountName -eq '$sam'" -ErrorAction SilentlyContinue)) {
        New-ADUser `
            -Name $name `
            -GivenName $first `
            -Surname $last `
            -SamAccountName $sam `
            -UserPrincipalName "$sam@eep-arngrimur.local" `
            -AccountPassword $defaultPassword `
            -Enabled $true `
            -Path $ou `
            -ChangePasswordAtLogon $true
    }
}
